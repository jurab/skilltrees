<!DOCTYPE html>
<html>
<head>
    <title>{{ tree.title }}</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <script src="https://unpkg.com/dagre@0.7.4/dist/dagre.js"></script>
    <script src="https://cytoscape.org/cytoscape.js-dagre/cytoscape-dagre.js"></script>
    <style>
        /* Theme: Claude (warm terracotta) - DEFAULT */
        :root {
            --bg-base: #1a1915;
            --bg-raised: #23211c;
            --bg-hover: #2d2a24;
            --border-subtle: #3d3930;
            --border-default: #4a453a;
            --border-hover: #6b6355;
            --text-muted: #6b6355;
            --text-dim: #8b8070;
            --text-secondary: #a69a88;
            --text-primary: #c4b59d;
            --text-bright: #e8dcc8;
            --color-action: #da7756;
            --color-action-bg: rgba(218, 119, 86, 0.08);
            --color-danger: #e63946;
            --bg-overlay: rgba(26, 25, 21, 0.95);
        }
        
        /* Theme: Matrix (dark hacker)
        :root {
            --bg-base: #050505;
            --bg-raised: #0a0a0a;
            --bg-hover: #111;
            --border-subtle: #1a1a1a;
            --border-default: #222;
            --border-hover: #444;
            --text-muted: #444;
            --text-dim: #555;
            --text-secondary: #666;
            --text-primary: #888;
            --text-bright: #aaa;
            --color-action: #00ff88;
            --color-action-bg: rgba(0, 255, 136, 0.05);
            --color-danger: #ff4444;
            --bg-overlay: rgba(5, 5, 5, 0.95);
        }
        */
        
        /* Theme: Ocean (deep blue)
        :root {
            --bg-base: #0a0e14;
            --bg-raised: #0d1219;
            --bg-hover: #141b24;
            --border-subtle: #1a2433;
            --border-default: #243044;
            --border-hover: #3a4d66;
            --text-muted: #3a4d66;
            --text-dim: #4a6080;
            --text-secondary: #6b8aad;
            --text-primary: #8aa8c7;
            --text-bright: #b8d4f0;
            --color-action: #5ccfe6;
            --color-action-bg: rgba(92, 207, 230, 0.08);
            --color-danger: #ff6b6b;
            --bg-overlay: rgba(10, 14, 20, 0.95);
        }
        */
        
        /* Theme: Amber (warm dark)
        :root {
            --bg-base: #0f0d09;
            --bg-raised: #1a1610;
            --bg-hover: #252015;
            --border-subtle: #2d2618;
            --border-default: #3d3420;
            --border-hover: #5c4d30;
            --text-muted: #5c4d30;
            --text-dim: #7a6840;
            --text-secondary: #a08850;
            --text-primary: #c4a860;
            --text-bright: #e8d090;
            --color-action: #f0a020;
            --color-action-bg: rgba(240, 160, 32, 0.08);
            --color-danger: #e05040;
            --bg-overlay: rgba(15, 13, 9, 0.95);
        }
        */
        
        /* Theme: Flashbang (clean white)
        :root {
            --bg-base: #ffffff;
            --bg-raised: #f5f5f5;
            --bg-hover: #ebebeb;
            --border-subtle: #e0e0e0;
            --border-default: #d0d0d0;
            --border-hover: #a0a0a0;
            --text-muted: #c0c0c0;
            --text-dim: #a0a0a0;
            --text-secondary: #707070;
            --text-primary: #505050;
            --text-bright: #202020;
            --color-action: #10b981;
            --color-action-bg: rgba(16, 185, 129, 0.08);
            --color-danger: #ef4444;
            --bg-overlay: rgba(255, 255, 255, 0.95);
        }
        */
        
        body {
            background: var(--bg-base);
            margin: 0;
            overflow-x: scroll;
            overflow-y: hidden;
            font-family: 'courier new', monospace;
        }
        #cy {
            height: 100vh;
            margin-right: 250px;
        }
        body.sidebar-collapsed #cy {
            margin-right: 0;
        }
        .ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: var(--text-secondary);
            font-size: 11px;
            z-index: 10;
            line-height: 1.6;
            pointer-events: none;
        }
        .ui b {
            color: var(--text-bright);
        }
        
        /* Settings */
        #settings-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 24px;
            height: 24px;
            background: var(--bg-raised);
            border: 1px solid var(--border-default);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            z-index: 60;
        }
        #settings-toggle:hover {
            border-color: var(--border-hover);
            color: var(--text-primary);
        }
        #settings-panel {
            display: none;
            position: fixed;
            top: 54px;
            left: 20px;
            background: var(--bg-raised);
            border: 1px solid var(--border-default);
            padding: 15px;
            z-index: 60;
            min-width: 150px;
        }
        #settings-panel.active {
            display: block;
        }
        #settings-panel h3 {
            color: var(--text-bright);
            font-size: 11px;
            font-weight: normal;
            margin: 0 0 10px 0;
        }
        .theme-option {
            display: block;
            padding: 8px 10px;
            color: var(--text-dim);
            font-size: 11px;
            cursor: pointer;
            border: 1px solid transparent;
            margin-bottom: 4px;
        }
        .theme-option:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        .theme-option.active {
            border-color: var(--color-action);
            color: var(--color-action);
        }

        /* Sidebar */
        #sidebar {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 15px;
            width: 250px;
            background: var(--bg-raised);
            border-left: 1px solid var(--border-subtle);
            z-index: 50;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }
        #sidebar.collapsed {
            transform: translateX(250px);
        }
        #sidebar-toggle {
            position: fixed;
            top: 20px;
            right: 260px;
            width: 24px;
            height: 24px;
            background: var(--bg-raised);
            border: 1px solid var(--border-default);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            z-index: 51;
            transition: right 0.3s ease;
        }
        #sidebar-toggle:hover {
            border-color: var(--border-hover);
            color: var(--text-primary);
        }
        #sidebar.collapsed ~ #sidebar-toggle {
            right: 10px;
        }
        #sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            font-size: 11px;
        }
        #sidebar-header b {
            color: var(--text-bright);
        }
        #sidebar-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }
        .sidebar-item {
            padding: 10px 20px;
            color: var(--text-dim);
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sidebar-item:hover {
            background: var(--bg-hover);
        }
        .sidebar-item.done {
            opacity: 0.6;
        }
        .sidebar-item.done .checkmark {
            display: inline;
        }
        .sidebar-item.skipped {
            opacity: 0.6;
        }
        .sidebar-item.ignored {
            opacity: 0.4;
            color: var(--color-danger);
        }
        .sidebar-item.next {
            color: var(--color-action);
            background: var(--color-action-bg);
        }
        .sidebar-item .checkmark {
            display: none;
            color: var(--color-action);
        }
        .sidebar-item.highlight {
            background: var(--bg-hover);
            color: var(--text-bright);
        }

        /* Node detail overlay */
        #node-detail {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--bg-overlay);
            z-index: 100;
        }
        #node-detail.active {
            display: flex;
            padding: 40px;
            box-sizing: border-box;
            overflow-y: auto;
            gap: 30px;
        }
        #node-detail-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            z-index: 101;
        }
        #node-detail-close:hover {
            color: var(--text-bright);
        }
        #node-detail-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 900px;
        }
        #node-detail-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        #node-detail-title {
            color: var(--text-bright);
            font-size: 18px;
            text-align: center;
            flex: 1;
        }
        #node-detail-ignore {
            background: transparent;
            border: 1px solid var(--color-danger);
            color: var(--color-danger);
            padding: 8px 16px;
            font-family: 'courier new', monospace;
            font-size: 11px;
            cursor: pointer;
        }
        #node-detail-ignore:hover {
            background: var(--color-danger);
            color: var(--bg-base);
        }
        #node-detail-ignore.is-ignored {
            border-color: var(--text-secondary);
            color: var(--text-secondary);
        }
        #node-detail-ignore.is-ignored:hover {
            background: var(--text-secondary);
            color: var(--bg-base);
        }
        #node-detail-complete {
            background: transparent;
            border: 1px solid var(--color-action);
            color: var(--color-action);
            padding: 8px 16px;
            font-family: 'courier new', monospace;
            font-size: 11px;
            cursor: pointer;
        }
        #node-detail-complete:hover {
            background: var(--color-action);
            color: var(--bg-base);
        }
        #node-detail-complete.is-done {
            border-color: var(--text-secondary);
            color: var(--text-secondary);
        }
        #node-detail-complete.is-done:hover {
            background: var(--text-secondary);
            color: var(--bg-base);
        }
        #node-detail-video {
            width: 100%;
            aspect-ratio: 16/9;
            background: black;
            border: 1px solid var(--border-default);
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        #node-detail-video iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        #node-detail-resources {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .resource-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 12px;
            padding: 10px 15px;
            border: 1px solid var(--border-default);
            cursor: pointer;
        }
        .resource-item:hover {
            border-color: var(--border-hover);
            color: var(--text-primary);
        }
        .resource-icon {
            font-size: 16px;
        }
        #node-detail-description {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.8;
        }
        #node-detail-sequence {
            width: 250px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            max-height: 100%;
        }
        #node-detail-sequence h3 {
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: normal;
            margin-bottom: 15px;
            padding-top: 50px;
        }
        #node-detail-sequence-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            overflow-y: auto;
        }
        .sequence-item {
            color: var(--text-dim);
            font-size: 11px;
            padding: 8px 12px;
            border: 1px solid transparent;
            cursor: pointer;
        }
        .sequence-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        .sequence-item.current {
            border-color: var(--text-bright);
            color: var(--text-bright);
        }
        .sequence-item.done {
            opacity: 0.5;
            color: var(--color-action);
        }
        .sequence-item.done::before {
            content: '✓ ';
        }
        .sequence-item.ignored {
            opacity: 0.4;
            color: var(--color-danger);
        }
        .sequence-item.unfinished-prereq {
            border-color: var(--color-danger);
            color: var(--text-primary);
        }

        /* Pause button */
        #pause-button-container {
            display: none;
            margin-top: 15px;
        }
        #pause-button-container.active {
            display: block;
        }
        #pause-button {
            background: transparent;
            border: 1px solid var(--color-action);
            color: var(--color-action);
            padding: 12px 24px;
            font-family: 'courier new', monospace;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        #pause-button:hover {
            background: var(--color-action);
            color: var(--bg-base);
        }
        #pause-button.salient {
            animation: pulse 1.5s ease-in-out infinite, shine 2s ease-in-out infinite;
        }
        #pause-button.clicked {
            animation: none;
            opacity: 0.6;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes shine {
            0%, 100% { box-shadow: 0 0 5px var(--color-action); }
            50% { box-shadow: 0 0 20px var(--color-action), 0 0 30px var(--color-action); }
        }
    </style>
</head>
<body>
    <div id="settings-toggle">&#9881;</div>
    <div id="settings-panel">
        <h3>theme</h3>
        <div class="theme-option active" data-theme="claude">claude</div>
        <div class="theme-option" data-theme="matrix">matrix</div>
        <div class="theme-option" data-theme="ocean">ocean</div>
        <div class="theme-option" data-theme="amber">amber</div>
        <div class="theme-option" data-theme="flashbang">flashbang</div>
    </div>
    <div class="ui" style="left: 55px;">
        <b>{{ tree.title }}</b><br>
        TAP: view skill<br>
        DBL-TAP: mark as DONE
    </div>
    <div id="cy"></div>

    <div id="sidebar">
        <div id="sidebar-header">
            <b>sequence</b>
        </div>
        <div id="sidebar-list"></div>
    </div>
    <div id="sidebar-toggle">&rsaquo;</div>

    <div id="node-detail">
        <div id="node-detail-close">&times;</div>
        <div id="node-detail-main">
            <div id="node-detail-header">
                <button id="node-detail-ignore">never again</button>
                <div id="node-detail-title">Skill Title</div>
                <button id="node-detail-complete">mark as complete</button>
            </div>
            <div id="node-detail-video"></div>
            <div id="pause-button-container">
                <button id="pause-button">continue</button>
            </div>

            <div id="node-detail-resources"></div>
            <div id="node-detail-description"></div>
        </div>
        <div id="node-detail-sequence">
            <h3>sequence</h3>
            <div id="node-detail-sequence-list"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var sequence = {{ sequence_json|safe }};

            // Theme definitions
            var themes = {
                claude: {
                    '--bg-base': '#1a1915', '--bg-raised': '#23211c', '--bg-hover': '#2d2a24',
                    '--border-subtle': '#3d3930', '--border-default': '#4a453a', '--border-hover': '#6b6355',
                    '--text-muted': '#6b6355', '--text-dim': '#8b8070', '--text-secondary': '#a69a88',
                    '--text-primary': '#c4b59d', '--text-bright': '#e8dcc8',
                    '--color-action': '#da7756', '--color-action-bg': 'rgba(218, 119, 86, 0.08)', '--color-danger': '#e63946',
                    '--bg-overlay': 'rgba(26, 25, 21, 0.95)'
                },
                matrix: {
                    '--bg-base': '#050505', '--bg-raised': '#0a0a0a', '--bg-hover': '#111',
                    '--border-subtle': '#1a1a1a', '--border-default': '#222', '--border-hover': '#444',
                    '--text-muted': '#444', '--text-dim': '#555', '--text-secondary': '#666',
                    '--text-primary': '#888', '--text-bright': '#aaa',
                    '--color-action': '#00ff88', '--color-action-bg': 'rgba(0, 255, 136, 0.05)', '--color-danger': '#ff4444',
                    '--bg-overlay': 'rgba(5, 5, 5, 0.95)'
                },
                ocean: {
                    '--bg-base': '#0a0e14', '--bg-raised': '#0d1219', '--bg-hover': '#141b24',
                    '--border-subtle': '#1a2433', '--border-default': '#243044', '--border-hover': '#3a4d66',
                    '--text-muted': '#3a4d66', '--text-dim': '#4a6080', '--text-secondary': '#6b8aad',
                    '--text-primary': '#8aa8c7', '--text-bright': '#b8d4f0',
                    '--color-action': '#5ccfe6', '--color-action-bg': 'rgba(92, 207, 230, 0.08)', '--color-danger': '#ff6b6b',
                    '--bg-overlay': 'rgba(10, 14, 20, 0.95)'
                },
                amber: {
                    '--bg-base': '#0f0d09', '--bg-raised': '#1a1610', '--bg-hover': '#252015',
                    '--border-subtle': '#2d2618', '--border-default': '#3d3420', '--border-hover': '#5c4d30',
                    '--text-muted': '#5c4d30', '--text-dim': '#7a6840', '--text-secondary': '#a08850',
                    '--text-primary': '#c4a860', '--text-bright': '#e8d090',
                    '--color-action': '#f0a020', '--color-action-bg': 'rgba(240, 160, 32, 0.08)', '--color-danger': '#e05040',
                    '--bg-overlay': 'rgba(15, 13, 9, 0.95)'
                },
                flashbang: {
                    '--bg-base': '#ffffff', '--bg-raised': '#f5f5f5', '--bg-hover': '#ebebeb',
                    '--border-subtle': '#e0e0e0', '--border-default': '#d0d0d0', '--border-hover': '#a0a0a0',
                    '--text-muted': '#c0c0c0', '--text-dim': '#a0a0a0', '--text-secondary': '#707070',
                    '--text-primary': '#505050', '--text-bright': '#202020',
                    '--color-action': '#10b981', '--color-action-bg': 'rgba(16, 185, 129, 0.08)', '--color-danger': '#ef4444',
                    '--bg-overlay': 'rgba(255, 255, 255, 0.95)'
                }
            };

            // Get CSS variable values for Cytoscape
            var style = getComputedStyle(document.documentElement);
            var colors = {
                bgBase: style.getPropertyValue('--bg-base').trim(),
                borderSubtle: style.getPropertyValue('--border-subtle').trim(),
                borderDefault: style.getPropertyValue('--border-default').trim(),
                textPrimary: style.getPropertyValue('--text-primary').trim(),
                textBright: style.getPropertyValue('--text-bright').trim(),
                colorAction: style.getPropertyValue('--color-action').trim(),
                colorDanger: style.getPropertyValue('--color-danger').trim()
            };

            var cy = cytoscape({
                container: document.getElementById('cy'),
                elements: {{ elements_json|safe }},
                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': colors.bgBase,
                            'label': 'data(name)',
                            'color': colors.textPrimary,
                            'font-family': 'monospace',
                            'font-size': '10px',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'width': '140px',
                            'height': '35px',
                            'border-width': 1,
                            'border-color': colors.borderDefault,
                            'shape': 'round-rectangle',
                            'transition-property': 'background-color, border-color, color, opacity',
                            'transition-duration': '0.3s'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 1,
                            'line-color': colors.borderSubtle,
                            'target-arrow-color': colors.borderSubtle,
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier'
                        }
                    },
                    {
                        selector: '.done',
                        style: {
                            'opacity': 0.6,
                            'label': function(ele) { return '✓  ' + ele.data('name'); },
                            'color': colors.colorAction
                        }
                    },
                    {
                        selector: '.skipped',
                        style: {
                            'opacity': 0.6
                        }
                    },
                    {
                        selector: '.ignored',
                        style: {
                            'opacity': 0.4,
                            'border-color': colors.colorDanger,
                            'color': colors.colorDanger
                        }
                    },
                    {
                        selector: '.next',
                        style: {
                            'border-color': colors.colorAction,
                            'color': colors.colorAction,
                            'border-width': 2
                        }
                    },
                    {
                        selector: '.highlight',
                        style: {
                            'border-color': colors.textBright,
                            'border-width': 2
                        }
                    }
                ],
                layout: { name: 'preset' }, // Don't run layout yet
                userZoomingEnabled: false,
                userPanningEnabled: false,
                boxSelectionEnabled: false,
                autoungrabify: true
            });

            // Run layout manually so we can attach handler first
            function fitGraph() {
                var cyDiv = document.getElementById('cy');
                var bb = cy.elements().boundingBox();
                var viewportHeight = window.innerHeight;
                var viewportWidth = window.innerWidth - 250; // sidebar
                var padding = 40;
                
                // Scale to fit viewport height
                var scale = (viewportHeight - padding * 2) / bb.h;
                scale = Math.min(scale, 1);
                
                // Calculate width needed for the scaled graph
                var graphWidth = bb.w * scale + padding * 2;
                var finalWidth = Math.max(graphWidth, viewportWidth);
                
                // Set cy div width to enable horizontal scrolling
                cyDiv.style.width = finalWidth + 'px';
                
                // Resize cytoscape to match new div size
                cy.resize();
                
                // Set zoom and center vertically
                cy.zoom(scale);
                cy.pan({
                    x: padding - bb.x1 * scale,
                    y: (viewportHeight - bb.h * scale) / 2 - bb.y1 * scale
                });
            }

            // Run dagre layout, then fit after DOM is ready
            var layout = cy.layout({
                name: 'dagre',
                rankDir: 'LR',
                nodeSep: 50,
                rankSep: 100,
                fit: false
            });
            layout.run();
            
            // Wait for layout and DOM to be ready
            setTimeout(function() {
                fitGraph();
            }, 100);

            // Apply initial states from server
            cy.nodes().forEach(function(node) {
                if (node.data('ignored')) {
                    node.addClass('ignored');
                } else if (node.data('done')) {
                    node.addClass('done');
                } else if (node.data('next')) {
                    node.addClass('next');
                } else if (node.data('skipped')) {
                    node.addClass('skipped');
                }
            });

            // Sidebar
            var sidebar = document.getElementById('sidebar');
            var sidebarToggle = document.getElementById('sidebar-toggle');
            var sidebarList = document.getElementById('sidebar-list');

            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('collapsed');
                document.body.classList.toggle('sidebar-collapsed');
                sidebarToggle.textContent = sidebar.classList.contains('collapsed') ? '\u2039' : '\u203a';
            });

            function renderSidebar() {
                sidebarList.innerHTML = '';
                sequence.forEach(function(item) {
                    var div = document.createElement('div');
                    div.className = 'sidebar-item';
                    if (item.ignored) div.classList.add('ignored');
                    else if (item.done) div.classList.add('done');
                    if (item.next) div.classList.add('next');
                    if (item.skipped) div.classList.add('skipped');
                    div.dataset.nodeId = item.node_id;
                    div.dataset.skillId = item.skill_id;
                    div.innerHTML = '<span class="checkmark">&#10003;</span><span>' + item.name + '</span>';
                    sidebarList.appendChild(div);
                });
            }
            renderSidebar();

            function updateStates() {
                // Find all skipped nodes: ancestors of done nodes that are not done themselves
                var skippedNodeIds = new Set();
                cy.nodes().forEach(function(node) {
                    if (node.data('done')) {
                        // Get all ancestors (predecessors recursively)
                        var ancestors = node.predecessors('node');
                        ancestors.forEach(function(ancestor) {
                            if (!ancestor.data('done') && !ancestor.data('ignored')) {
                                skippedNodeIds.add(ancestor.id());
                            }
                        });
                    }
                });

                // Find next (first non-done, non-skipped, non-ignored in sequence)
                var nextIdx = -1;
                for (var i = 0; i < sequence.length; i++) {
                    var node = cy.getElementById(sequence[i].node_id);
                    if (!node.data('done') && !node.data('ignored') && !skippedNodeIds.has(sequence[i].node_id)) {
                        nextIdx = i;
                        break;
                    }
                }

                // Update sequence data and nodes
                for (var i = 0; i < sequence.length; i++) {
                    var item = sequence[i];
                    var node = cy.getElementById(item.node_id);
                    var isDone = node.data('done');
                    var isIgnored = node.data('ignored');
                    var isSkipped = skippedNodeIds.has(item.node_id);
                    var isNext = (i === nextIdx);

                    item.done = isDone;
                    item.ignored = isIgnored;
                    item.next = isNext;
                    item.skipped = isSkipped;

                    node.removeClass('done next skipped ignored');
                    if (isIgnored) node.addClass('ignored');
                    else if (isDone) node.addClass('done');
                    else if (isNext) node.addClass('next');
                    else if (isSkipped) node.addClass('skipped');
                }

                renderSidebar();
            }

            var nodeDetail = document.getElementById('node-detail');
            var nodeDetailTitle = document.getElementById('node-detail-title');
            var nodeDetailClose = document.getElementById('node-detail-close');
            var nodeDetailSequenceList = document.getElementById('node-detail-sequence-list');
            var nodeDetailComplete = document.getElementById('node-detail-complete');
            var nodeDetailIgnore = document.getElementById('node-detail-ignore');
            var currentNode = null;
            var tapTimeout = null;
            var tapDelay = 250;

            function updateButtons() {
                if (!currentNode) return;
                
                // Update complete button
                if (currentNode.data('done')) {
                    nodeDetailComplete.textContent = 'completed';
                    nodeDetailComplete.classList.add('is-done');
                } else {
                    nodeDetailComplete.textContent = 'mark as complete';
                    nodeDetailComplete.classList.remove('is-done');
                }
                
                // Update ignore button
                if (currentNode.data('ignored')) {
                    nodeDetailIgnore.textContent = 'ignored';
                    nodeDetailIgnore.classList.add('is-ignored');
                } else {
                    nodeDetailIgnore.textContent = 'never again';
                    nodeDetailIgnore.classList.remove('is-ignored');
                }
            }

            function toggleNodeCompletion(nodeId, callback) {
                // Extract numeric id from 'n123' format
                var numericId = nodeId.replace('n', '');
                fetch('/node/' + numericId + '/toggle/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error(data.error);
                        return;
                    }
                    // Update all nodes with the same skill_id
                    cy.nodes().forEach(function(n) {
                        if (n.data('skill_id') === data.skill_id) {
                            n.data('done', data.done);
                        }
                    });
                    updateStates();
                    if (callback) callback(data);
                })
                .catch(err => console.error('Error:', err));
            }

            function toggleNodeIgnore(nodeId, callback) {
                var numericId = nodeId.replace('n', '');
                fetch('/node/' + numericId + '/ignore/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error(data.error);
                        return;
                    }
                    // Update all nodes with the same skill_id
                    cy.nodes().forEach(function(n) {
                        if (n.data('skill_id') === data.skill_id) {
                            n.data('ignored', data.ignored);
                            if (data.ignored) {
                                n.data('done', false);
                            }
                        }
                    });
                    updateStates();
                    if (callback) callback(data);
                })
                .catch(err => console.error('Error:', err));
            }

            // YouTube API loading
            var ytReady = false;
            var ytReadyCallbacks = [];
            
            function loadYouTubeAPI() {
                if (window.YT && window.YT.Player) {
                    ytReady = true;
                    return;
                }
                var tag = document.createElement('script');
                tag.src = 'https://www.youtube.com/iframe_api';
                var firstScript = document.getElementsByTagName('script')[0];
                firstScript.parentNode.insertBefore(tag, firstScript);
            }
            
            window.onYouTubeIframeAPIReady = function() {
                ytReady = true;
                ytReadyCallbacks.forEach(function(cb) { cb(); });
                ytReadyCallbacks = [];
            };
            
            function whenYTReady(callback) {
                if (ytReady) {
                    callback();
                } else {
                    ytReadyCallbacks.push(callback);
                }
            }
            
            loadYouTubeAPI();

            // YouTube player and pause state
            var player = null;
            var currentPauses = [];
            var nextPauseIndex = 0;
            var pauseCheckInterval = null;
            var nodeDetailVideo = document.getElementById('node-detail-video');
            var pauseButtonContainer = document.getElementById('pause-button-container');
            var pauseButton = document.getElementById('pause-button');
            var currentPauseData = null;

            function extractVideoId(url) {
                // Handle embed URLs: https://www.youtube.com/embed/VIDEO_ID
                var embedMatch = url.match(/\/embed\/([^?&]+)/);
                if (embedMatch) return embedMatch[1];
                // Handle watch URLs: https://www.youtube.com/watch?v=VIDEO_ID
                var watchMatch = url.match(/[?&]v=([^&]+)/);
                if (watchMatch) return watchMatch[1];
                // Handle short URLs: https://youtu.be/VIDEO_ID
                var shortMatch = url.match(/youtu\.be\/([^?&]+)/);
                if (shortMatch) return shortMatch[1];
                return null;
            }

            function setupVideo(videoUrl, pauses) {
                currentPauses = pauses || [];
                nextPauseIndex = 0;
                currentPauseData = null;
                
                // Hide pause button initially
                pauseButtonContainer.classList.remove('active');
                pauseButton.classList.remove('salient', 'clicked');
                
                // Clear any existing interval
                if (pauseCheckInterval) {
                    clearInterval(pauseCheckInterval);
                    pauseCheckInterval = null;
                }
                
                var videoId = extractVideoId(videoUrl);
                if (!videoId) {
                    nodeDetailVideo.innerHTML = '<span style="color:var(--text-muted);">Invalid video URL</span>';
                    return;
                }
                
                // Destroy existing player
                if (player) {
                    player.destroy();
                    player = null;
                }
                
                // Create new player once API is ready
                nodeDetailVideo.innerHTML = '<div id="yt-player"></div>';
                whenYTReady(function() {
                    player = new YT.Player('yt-player', {
                        videoId: videoId,
                        playerVars: {
                            'playsinline': 1
                        },
                        events: {
                            'onReady': onPlayerReady,
                            'onStateChange': onPlayerStateChange
                        }
                    });
                });
            }

            function onPlayerReady(event) {
                // Start checking for pause points
                if (currentPauses.length > 0) {
                    pauseCheckInterval = setInterval(checkPausePoints, 200);
                }
            }

            function onPlayerStateChange(event) {
                // If video ends or is paused by user, stop checking
                if (event.data === YT.PlayerState.ENDED) {
                    if (pauseCheckInterval) {
                        clearInterval(pauseCheckInterval);
                        pauseCheckInterval = null;
                    }
                }
            }

            function checkPausePoints() {
                if (!player || nextPauseIndex >= currentPauses.length) return;
                
                var currentTime = player.getCurrentTime();
                var nextPause = currentPauses[nextPauseIndex];
                
                if (currentTime >= nextPause.time) {
                    // Pause the video
                    player.pauseVideo();
                    
                    // Show the button
                    currentPauseData = nextPause;
                    pauseButton.textContent = nextPause.title;
                    pauseButton.classList.remove('clicked');
                    pauseButton.classList.add('salient');
                    pauseButtonContainer.classList.add('active');
                    
                    nextPauseIndex++;
                }
            }

            function handlePauseButtonClick() {
                if (!currentPauseData) return;
                
                // Handle clipboard - don't auto-resume, user needs to paste somewhere
                if (currentPauseData.clipboard) {
                    navigator.clipboard.writeText(currentPauseData.clipboard).then(function() {
                        console.log('Copied to clipboard');
                    }).catch(function(err) {
                        console.error('Failed to copy:', err);
                    });
                    pauseButton.classList.remove('salient');
                    pauseButton.classList.add('clicked');
                    return;
                }
                
                // Handle attachment download - don't auto-resume
                if (currentPauseData.attachment_url) {
                    window.open(currentPauseData.attachment_url, '_blank');
                    pauseButton.classList.remove('salient');
                    pauseButton.classList.add('clicked');
                    return;
                }
                
                // Continue button (no clipboard/attachment) - resume video
                pauseButton.classList.remove('salient');
                pauseButton.classList.add('clicked');
                if (player) {
                    player.playVideo();
                }
            }

            pauseButton.addEventListener('click', handlePauseButtonClick);

            function showNodeDetail(node) {
                currentNode = node;
                nodeDetailTitle.textContent = currentNode.data('name');

                // Get unfinished prerequisites for this node
                var ancestors = currentNode.predecessors('node');
                var unfinishedPrereqIds = new Set();
                ancestors.forEach(function(prereq) {
                    if (!prereq.data('done') && !prereq.data('ignored')) {
                        unfinishedPrereqIds.add(prereq.id());
                    }
                });

                // Render full sequence list
                nodeDetailSequenceList.innerHTML = '';
                sequence.forEach(function(seqItem) {
                    var item = document.createElement('div');
                    item.className = 'sequence-item';
                    
                    var seqNode = cy.getElementById(seqItem.node_id);
                    
                    // Mark current node
                    if (seqItem.node_id === currentNode.id()) {
                        item.classList.add('current');
                    }
                    // Mark done
                    if (seqNode.data('done')) {
                        item.classList.add('done');
                    }
                    // Mark ignored
                    if (seqNode.data('ignored')) {
                        item.classList.add('ignored');
                    }
                    // Mark unfinished prerequisites
                    if (unfinishedPrereqIds.has(seqItem.node_id)) {
                        item.classList.add('unfinished-prereq');
                    }
                    
                    item.textContent = seqItem.name;
                    item.dataset.nodeId = seqItem.node_id;
                    item.dataset.skillId = seqItem.skill_id;
                    nodeDetailSequenceList.appendChild(item);
                });

                // Setup video with pauses
                var videoUrl = currentNode.data('video_url');
                var pauses = currentNode.data('pauses') || [];
                setupVideo(videoUrl, pauses);

                updateButtons();
                nodeDetail.classList.add('active');
                
                // Scroll current item into view
                var currentItem = nodeDetailSequenceList.querySelector('.current');
                if (currentItem) {
                    currentItem.scrollIntoView({ block: 'center', behavior: 'smooth' });
                }
            }

            // single tap: show node detail (with delay to allow double-tap)
            cy.on('tap', 'node', function(evt) {
                var tappedNode = evt.target;
                
                if (tapTimeout) {
                    clearTimeout(tapTimeout);
                    tapTimeout = null;
                    return;
                }
                
                tapTimeout = setTimeout(function() {
                    tapTimeout = null;
                    showNodeDetail(tappedNode);
                }, tapDelay);
            });

            // Highlight sync - hovering highlights all nodes/items with same skill
            function highlightSkill(skillId) {
                // Highlight graph nodes
                cy.nodes().forEach(function(node) {
                    if (node.data('skill_id') === skillId) {
                        node.addClass('highlight');
                    }
                });
                // Highlight sidebar items
                document.querySelectorAll('.sidebar-item').forEach(function(item) {
                    if (parseInt(item.dataset.skillId) === skillId) {
                        item.classList.add('highlight');
                    }
                });
            }
            
            function clearHighlight() {
                cy.nodes().removeClass('highlight');
                document.querySelectorAll('.sidebar-item').forEach(function(item) {
                    item.classList.remove('highlight');
                });
            }

            // Sidebar hover
            sidebarList.addEventListener('mouseover', function(e) {
                var item = e.target.closest('.sidebar-item');
                if (!item) return;
                var skillId = parseInt(item.dataset.skillId);
                highlightSkill(skillId);
            });
            sidebarList.addEventListener('mouseout', function(e) {
                var item = e.target.closest('.sidebar-item');
                if (!item) return;
                clearHighlight();
            });

            // Graph node hover
            cy.on('mouseover', 'node', function(evt) {
                var skillId = evt.target.data('skill_id');
                highlightSkill(skillId);
            });
            cy.on('mouseout', 'node', function(evt) {
                clearHighlight();
            });

            // Sidebar click handling
            var sidebarTapTimeout = null;
            sidebarList.addEventListener('click', function(e) {
                var item = e.target.closest('.sidebar-item');
                if (!item) return;

                var nodeId = item.dataset.nodeId;
                var skillId = parseInt(item.dataset.skillId);
                var node = cy.getElementById(nodeId);

                if (sidebarTapTimeout) {
                    clearTimeout(sidebarTapTimeout);
                    sidebarTapTimeout = null;
                    toggleNodeCompletion(nodeId);
                } else {
                    sidebarTapTimeout = setTimeout(function() {
                        sidebarTapTimeout = null;
                        showNodeDetail(node);
                    }, tapDelay);
                }
            });

            // sequence click handling (single = navigate, double = toggle)
            var seqTapTimeout = null;
            nodeDetailSequenceList.addEventListener('click', function(e) {
                var item = e.target.closest('.sequence-item');
                if (!item) return;

                var nodeId = item.dataset.nodeId;
                var skillId = parseInt(item.dataset.skillId);
                var seqNode = cy.getElementById(nodeId);

                if (seqTapTimeout) {
                    clearTimeout(seqTapTimeout);
                    seqTapTimeout = null;
                    toggleNodeCompletion(nodeId, function(data) {
                        // Refresh the sequence list to update all states
                        showNodeDetail(currentNode);
                    });
                } else {
                    seqTapTimeout = setTimeout(function() {
                        seqTapTimeout = null;
                        showNodeDetail(seqNode);
                    }, tapDelay);
                }
            });

            // complete button click
            nodeDetailComplete.addEventListener('click', function() {
                if (!currentNode) return;
                var nodeId = currentNode.id();
                toggleNodeCompletion(nodeId, function(data) {
                    updateButtons();
                });
            });

            // ignore button click
            nodeDetailIgnore.addEventListener('click', function() {
                if (!currentNode) return;
                var nodeId = currentNode.id();
                toggleNodeIgnore(nodeId, function(data) {
                    updateButtons();
                });
            });

            // close node detail
            function closeNodeDetail() {
                nodeDetail.classList.remove('active');
                currentNode = null;
                
                // Cleanup video
                if (pauseCheckInterval) {
                    clearInterval(pauseCheckInterval);
                    pauseCheckInterval = null;
                }
                if (player) {
                    player.destroy();
                    player = null;
                }
                pauseButtonContainer.classList.remove('active');
            }

            nodeDetailClose.addEventListener('click', closeNodeDetail);

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeNodeDetail();
                }
            });

            nodeDetail.addEventListener('click', function(e) {
                if (e.target === nodeDetail) {
                    closeNodeDetail();
                }
            });

            // double tap: toggle skill completion (graph shortcut)
            cy.on('dbltap', 'node', function(evt) {
                var node = evt.target;
                var nodeId = node.id();
                toggleNodeCompletion(nodeId);
            });

            // Slow down scroll speed (except in sidebar and node detail)
            document.addEventListener('wheel', function(e) {
                if (e.target.closest('#sidebar') || e.target.closest('#node-detail')) {
                    return; // Let these scroll normally
                }
                e.preventDefault();
                var scrollSpeed = 0.3;
                window.scrollBy(e.deltaX * scrollSpeed, e.deltaY * scrollSpeed);
            }, { passive: false });

            // Settings panel
            var settingsToggle = document.getElementById('settings-toggle');
            var settingsPanel = document.getElementById('settings-panel');
            
            settingsToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                settingsPanel.classList.toggle('active');
            });
            
            document.addEventListener('click', function(e) {
                if (!settingsPanel.contains(e.target) && e.target !== settingsToggle) {
                    settingsPanel.classList.remove('active');
                }
            });

            // Theme switching
            function applyTheme(themeName) {
                var theme = themes[themeName];
                if (!theme) return;
                
                var root = document.documentElement;
                for (var prop in theme) {
                    root.style.setProperty(prop, theme[prop]);
                }
                
                // Update Cytoscape colors
                colors.bgBase = theme['--bg-base'];
                colors.borderSubtle = theme['--border-subtle'];
                colors.borderDefault = theme['--border-default'];
                colors.textPrimary = theme['--text-primary'];
                colors.textBright = theme['--text-bright'];
                colors.colorAction = theme['--color-action'];
                colors.colorDanger = theme['--color-danger'];
                
                // Update Cytoscape styles
                cy.style()
                    .selector('node').style({ 'background-color': colors.bgBase, 'color': colors.textPrimary, 'border-color': colors.borderDefault })
                    .selector('edge').style({ 'line-color': colors.borderSubtle, 'target-arrow-color': colors.borderSubtle })
                    .selector('.done').style({ 'color': colors.colorAction })
                    .selector('.ignored').style({ 'border-color': colors.colorDanger, 'color': colors.colorDanger })
                    .selector('.next').style({ 'border-color': colors.colorAction, 'color': colors.colorAction })
                    .selector('.highlight').style({ 'border-color': colors.textBright })
                    .update();
                
                // Save preference
                localStorage.setItem('skilltrees-theme', themeName);
                
                // Update active state
                document.querySelectorAll('.theme-option').forEach(function(opt) {
                    opt.classList.toggle('active', opt.dataset.theme === themeName);
                });
            }

            // Theme option clicks
            document.querySelectorAll('.theme-option').forEach(function(opt) {
                opt.addEventListener('click', function() {
                    applyTheme(this.dataset.theme);
                });
            });

            // Load saved theme
            var savedTheme = localStorage.getItem('skilltrees-theme');
            if (savedTheme && themes[savedTheme]) {
                applyTheme(savedTheme);
            }
        });
    </script>
</body>
</html>
