<!DOCTYPE html>
<html>
<head>
    <title>{{ tree.title }}</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <script src="https://unpkg.com/dagre@0.7.4/dist/dagre.js"></script>
    <script src="https://cytoscape.org/cytoscape.js-dagre/cytoscape-dagre.js"></script>
    <style>
        body {
            background: #050505;
            margin: 0;
            overflow-x: scroll;
            overflow-y: hidden;
            font-family: 'courier new', monospace;
        }
        #cy {
            height: 100vh;
            margin-right: 250px;
        }
        body.sidebar-collapsed #cy {
            margin-right: 0;
        }
        .ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #666;
            font-size: 11px;
            z-index: 10;
            line-height: 1.6;
            pointer-events: none;
        }
        .ui b {
            color: #aaa;
        }

        /* Sidebar */
        #sidebar {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 15px;
            width: 250px;
            background: #0a0a0a;
            border-left: 1px solid #1a1a1a;
            z-index: 50;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }
        #sidebar.collapsed {
            transform: translateX(250px);
        }
        #sidebar-toggle {
            position: fixed;
            top: 20px;
            right: 260px;
            width: 24px;
            height: 24px;
            background: #0a0a0a;
            border: 1px solid #222;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            z-index: 51;
            transition: right 0.3s ease;
        }
        #sidebar-toggle:hover {
            border-color: #444;
            color: #888;
        }
        #sidebar.collapsed ~ #sidebar-toggle {
            right: 10px;
        }
        #sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #1a1a1a;
            color: #666;
            font-size: 11px;
        }
        #sidebar-header b {
            color: #aaa;
        }
        #sidebar-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }
        .sidebar-item {
            padding: 10px 20px;
            color: #555;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sidebar-item:hover {
            background: #111;
        }
        .sidebar-item.done {
            opacity: 0.6;
        }
        .sidebar-item.done .checkmark {
            display: inline;
        }
        .sidebar-item.skipped {
            opacity: 0.6;
        }
        .sidebar-item.next {
            color: #00ff88;
            background: rgba(0, 255, 136, 0.05);
        }
        .sidebar-item .checkmark {
            display: none;
            color: #00ff88;
        }

        /* Node detail overlay */
        #node-detail {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100;
        }
        #node-detail.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        #node-detail-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: #666;
            font-size: 24px;
            cursor: pointer;
            z-index: 101;
        }
        #node-detail-close:hover {
            color: #aaa;
        }
        #node-detail-title {
            color: #aaa;
            font-size: 18px;
            margin-bottom: 30px;
        }
        #node-detail-video {
            width: 100%;
            max-width: 800px;
            aspect-ratio: 16/9;
            background: #111;
            border: 1px solid #222;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #444;
        }
        #node-detail-video iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        #node-detail-resources {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        .resource-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-size: 12px;
            padding: 10px 15px;
            border: 1px solid #222;
            cursor: pointer;
        }
        .resource-item:hover {
            border-color: #444;
            color: #888;
        }
        .resource-icon {
            font-size: 16px;
        }
        #node-detail-description {
            max-width: 800px;
            color: #666;
            font-size: 13px;
            line-height: 1.8;
            margin-bottom: 30px;
        }
        #node-detail-prerequisites {
            max-width: 800px;
            width: 100%;
            margin-bottom: 30px;
        }
        #node-detail-prerequisites h3 {
            color: #666;
            font-size: 12px;
            font-weight: normal;
            margin-bottom: 10px;
        }
        #node-detail-prereq-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .prereq-item {
            color: #555;
            font-size: 11px;
            padding: 6px 12px;
            border: 1px solid #222;
            cursor: pointer;
        }
        .prereq-item:hover {
            border-color: #444;
            color: #888;
        }
        .prereq-item.done {
            opacity: 0.4;
        }
        #node-detail-complete {
            background: transparent;
            border: 1px solid #00ff88;
            color: #00ff88;
            padding: 12px 30px;
            font-family: 'courier new', monospace;
            font-size: 12px;
            cursor: pointer;
            margin-top: 20px;
        }
        #node-detail-complete:hover {
            background: #00ff88;
            color: #050505;
        }
        #node-detail-complete.is-done {
            border-color: #666;
            color: #666;
        }
        #node-detail-complete.is-done:hover {
            background: #666;
            color: #050505;
        }
    </style>
</head>
<body>
    <div class="ui">
        <b>{{ tree.title }}</b><br>
        TAP: view skill<br>
        DBL-TAP: mark as DONE
    </div>
    <div id="cy"></div>

    <div id="sidebar">
        <div id="sidebar-header">
            <b>sequence</b>
        </div>
        <div id="sidebar-list"></div>
    </div>
    <div id="sidebar-toggle">&rsaquo;</div>

    <div id="node-detail">
        <div id="node-detail-close">&times;</div>
        <div id="node-detail-title">Skill Title</div>
        <div id="node-detail-video">
            <span>video placeholder</span>
        </div>
        <div id="node-detail-resources">
            <div class="resource-item">
                <span class="resource-icon">&#8595;</span>
                <span>workflow.json</span>
            </div>
            <div class="resource-item">
                <span class="resource-icon">&#8595;</span>
                <span>config.json</span>
            </div>
        </div>
        <div id="node-detail-description">
            Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
        </div>
        <div id="node-detail-prerequisites">
            <h3>prerequisites</h3>
            <div id="node-detail-prereq-list"></div>
        </div>
        <button id="node-detail-complete">mark as complete</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var sequence = {{ sequence_json|safe }};

            var cy = cytoscape({
                container: document.getElementById('cy'),
                elements: {{ elements_json|safe }},
                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': '#050505',
                            'label': 'data(name)',
                            'color': '#888',
                            'font-family': 'monospace',
                            'font-size': '10px',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'width': '140px',
                            'height': '35px',
                            'border-width': 1,
                            'border-color': '#222',
                            'shape': 'round-rectangle',
                            'transition-property': 'background-color, border-color, color, opacity',
                            'transition-duration': '0.3s'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 1,
                            'line-color': '#1a1a1a',
                            'target-arrow-color': '#1a1a1a',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier'
                        }
                    },
                    {
                        selector: '.done',
                        style: {
                            'opacity': 0.6,
                            'label': function(ele) { return 'âœ“ ' + ele.data('name'); }
                        }
                    },
                    {
                        selector: '.skipped',
                        style: {
                            'opacity': 0.6
                        }
                    },
                    {
                        selector: '.next',
                        style: {
                            'border-color': '#00ff88',
                            'color': '#00ff88',
                            'border-width': 2
                        }
                    }
                ],
                layout: { name: 'preset' }, // Don't run layout yet
                userZoomingEnabled: false,
                userPanningEnabled: false,
                boxSelectionEnabled: false,
                autoungrabify: true
            });

            // Run layout manually so we can attach handler first
            function fitGraph() {
                var cyDiv = document.getElementById('cy');
                var bb = cy.elements().boundingBox();
                var viewportHeight = window.innerHeight;
                var viewportWidth = window.innerWidth - 250; // sidebar
                var padding = 40;
                
                // Scale to fit viewport height
                var scale = (viewportHeight - padding * 2) / bb.h;
                scale = Math.min(scale, 1);
                
                // Calculate width needed for the scaled graph
                var graphWidth = bb.w * scale + padding * 2;
                var finalWidth = Math.max(graphWidth, viewportWidth);
                
                // Set cy div width to enable horizontal scrolling
                cyDiv.style.width = finalWidth + 'px';
                
                // Resize cytoscape to match new div size
                cy.resize();
                
                // Set zoom and center vertically
                cy.zoom(scale);
                cy.pan({
                    x: padding - bb.x1 * scale,
                    y: (viewportHeight - bb.h * scale) / 2 - bb.y1 * scale
                });
            }

            // Run dagre layout, then fit after DOM is ready
            var layout = cy.layout({
                name: 'dagre',
                rankDir: 'LR',
                nodeSep: 50,
                rankSep: 100,
                fit: false
            });
            layout.run();
            
            // Wait for layout and DOM to be ready
            setTimeout(function() {
                fitGraph();
            }, 100);

            // Apply initial states from server
            cy.nodes().forEach(function(node) {
                if (node.data('done')) {
                    node.addClass('done');
                } else if (node.data('next')) {
                    node.addClass('next');
                } else if (node.data('skipped')) {
                    node.addClass('skipped');
                }
            });

            // Sidebar
            var sidebar = document.getElementById('sidebar');
            var sidebarToggle = document.getElementById('sidebar-toggle');
            var sidebarList = document.getElementById('sidebar-list');

            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('collapsed');
                document.body.classList.toggle('sidebar-collapsed');
                sidebarToggle.textContent = sidebar.classList.contains('collapsed') ? '\u2039' : '\u203a';
            });

            function renderSidebar() {
                sidebarList.innerHTML = '';
                sequence.forEach(function(item) {
                    var div = document.createElement('div');
                    div.className = 'sidebar-item';
                    if (item.done) div.classList.add('done');
                    if (item.next) div.classList.add('next');
                    if (item.skipped) div.classList.add('skipped');
                    div.dataset.nodeId = item.node_id;
                    div.dataset.skillId = item.skill_id;
                    div.innerHTML = '<span class="checkmark">&#10003;</span><span>' + item.name + '</span>';
                    sidebarList.appendChild(div);
                });
            }
            renderSidebar();

            function updateStates() {
                // Find all skipped nodes: ancestors of done nodes that are not done themselves
                var skippedNodeIds = new Set();
                cy.nodes().forEach(function(node) {
                    if (node.data('done')) {
                        // Get all ancestors (predecessors recursively)
                        var ancestors = node.predecessors('node');
                        ancestors.forEach(function(ancestor) {
                            if (!ancestor.data('done')) {
                                skippedNodeIds.add(ancestor.id());
                            }
                        });
                    }
                });

                // Find next (first non-done, non-skipped in sequence)
                var nextIdx = -1;
                for (var i = 0; i < sequence.length; i++) {
                    var node = cy.getElementById(sequence[i].node_id);
                    if (!node.data('done') && !skippedNodeIds.has(sequence[i].node_id)) {
                        nextIdx = i;
                        break;
                    }
                }

                // Update sequence data and nodes
                for (var i = 0; i < sequence.length; i++) {
                    var item = sequence[i];
                    var node = cy.getElementById(item.node_id);
                    var isDone = node.data('done');
                    var isSkipped = skippedNodeIds.has(item.node_id);
                    var isNext = (i === nextIdx);

                    item.done = isDone;
                    item.next = isNext;
                    item.skipped = isSkipped;

                    node.removeClass('done next skipped');
                    if (isDone) node.addClass('done');
                    else if (isNext) node.addClass('next');
                    else if (isSkipped) node.addClass('skipped');
                }

                renderSidebar();
            }

            var nodeDetail = document.getElementById('node-detail');
            var nodeDetailTitle = document.getElementById('node-detail-title');
            var nodeDetailClose = document.getElementById('node-detail-close');
            var nodeDetailPrereqList = document.getElementById('node-detail-prereq-list');
            var nodeDetailComplete = document.getElementById('node-detail-complete');
            var currentNode = null;
            var tapTimeout = null;
            var tapDelay = 250;

            function updateCompleteButton() {
                if (currentNode && currentNode.data('done')) {
                    nodeDetailComplete.textContent = 'mark as incomplete';
                    nodeDetailComplete.classList.add('is-done');
                } else {
                    nodeDetailComplete.textContent = 'mark as complete';
                    nodeDetailComplete.classList.remove('is-done');
                }
            }

            function toggleNodeCompletion(nodeId, callback) {
                // Extract numeric id from 'n123' format
                var numericId = nodeId.replace('n', '');
                fetch('/node/' + numericId + '/toggle/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error(data.error);
                        return;
                    }
                    // Update all nodes with the same skill_id
                    cy.nodes().forEach(function(n) {
                        if (n.data('skill_id') === data.skill_id) {
                            n.data('done', data.done);
                        }
                    });
                    updateStates();
                    if (callback) callback(data);
                })
                .catch(err => console.error('Error:', err));
            }

            function showNodeDetail(node) {
                currentNode = node;
                nodeDetailTitle.textContent = currentNode.data('name');

                // Get direct predecessors (first-order prerequisites)
                var predecessors = currentNode.incomers('node');
                nodeDetailPrereqList.innerHTML = '';

                if (predecessors.length === 0) {
                    nodeDetailPrereqList.innerHTML = '<span style="color:#444;font-size:11px;">none</span>';
                } else {
                    predecessors.forEach(function(prereq) {
                        var item = document.createElement('div');
                        item.className = 'prereq-item';
                        if (prereq.data('done')) {
                            item.classList.add('done');
                        }
                        item.textContent = prereq.data('name');
                        item.dataset.nodeId = prereq.id();
                        item.dataset.skillId = prereq.data('skill_id');
                        nodeDetailPrereqList.appendChild(item);
                    });
                }

                updateCompleteButton();
                nodeDetail.classList.add('active');
            }

            // single tap: show node detail (with delay to allow double-tap)
            cy.on('tap', 'node', function(evt) {
                var tappedNode = evt.target;
                
                if (tapTimeout) {
                    clearTimeout(tapTimeout);
                    tapTimeout = null;
                    return;
                }
                
                tapTimeout = setTimeout(function() {
                    tapTimeout = null;
                    showNodeDetail(tappedNode);
                }, tapDelay);
            });

            // Sidebar click handling
            var sidebarTapTimeout = null;
            sidebarList.addEventListener('click', function(e) {
                var item = e.target.closest('.sidebar-item');
                if (!item) return;

                var nodeId = item.dataset.nodeId;
                var skillId = parseInt(item.dataset.skillId);
                var node = cy.getElementById(nodeId);

                if (sidebarTapTimeout) {
                    clearTimeout(sidebarTapTimeout);
                    sidebarTapTimeout = null;
                    toggleNodeCompletion(nodeId);
                } else {
                    sidebarTapTimeout = setTimeout(function() {
                        sidebarTapTimeout = null;
                        showNodeDetail(node);
                    }, tapDelay);
                }
            });

            // prerequisite click handling (single = navigate, double = toggle)
            var prereqTapTimeout = null;
            nodeDetailPrereqList.addEventListener('click', function(e) {
                var item = e.target.closest('.prereq-item');
                if (!item) return;

                var nodeId = item.dataset.nodeId;
                var skillId = parseInt(item.dataset.skillId);
                var prereqNode = cy.getElementById(nodeId);

                if (prereqTapTimeout) {
                    clearTimeout(prereqTapTimeout);
                    prereqTapTimeout = null;
                    toggleNodeCompletion(nodeId, function(data) {
                        if (data.done) {
                            item.classList.add('done');
                        } else {
                            item.classList.remove('done');
                        }
                    });
                } else {
                    prereqTapTimeout = setTimeout(function() {
                        prereqTapTimeout = null;
                        showNodeDetail(prereqNode);
                    }, tapDelay);
                }
            });

            // complete button click
            nodeDetailComplete.addEventListener('click', function() {
                if (!currentNode) return;
                var nodeId = currentNode.id();
                toggleNodeCompletion(nodeId, function(data) {
                    updateCompleteButton();
                    var prereqItems = nodeDetailPrereqList.querySelectorAll('.prereq-item');
                    prereqItems.forEach(function(item) {
                        var prereqNode = cy.nodes().filter(function(n) {
                            return n.data('name') === item.textContent;
                        })[0];
                        if (prereqNode && prereqNode.data('done')) {
                            item.classList.add('done');
                        } else {
                            item.classList.remove('done');
                        }
                    });
                });
            });

            // close node detail
            nodeDetailClose.addEventListener('click', function() {
                nodeDetail.classList.remove('active');
                currentNode = null;
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    nodeDetail.classList.remove('active');
                    currentNode = null;
                }
            });

            nodeDetail.addEventListener('click', function(e) {
                if (e.target === nodeDetail) {
                    nodeDetail.classList.remove('active');
                    currentNode = null;
                }
            });

            // double tap: toggle skill completion (graph shortcut)
            cy.on('dbltap', 'node', function(evt) {
                var node = evt.target;
                var nodeId = node.id();
                toggleNodeCompletion(nodeId);
            });

            // Slow down scroll speed (except in sidebar)
            document.addEventListener('wheel', function(e) {
                if (e.target.closest('#sidebar')) {
                    return; // Let sidebar scroll normally
                }
                e.preventDefault();
                var scrollSpeed = 0.3;
                window.scrollBy(e.deltaX * scrollSpeed, e.deltaY * scrollSpeed);
            }, { passive: false });
        });
    </script>
</body>
</html>
